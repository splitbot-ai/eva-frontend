@using System.Globalization;
@using EvaComponentLibrary.Languages;
@using EvaComponentLibrary.Services;
@using EvaComponentLibrary.ViewModels;
@using EvaComponentLibrary.ViewModels.Cloud;
@using Microsoft.Extensions.Localization;
@inject IStringLocalizer<MyStrings> _locals;
@inject NavigationManager NavigationManager;
@inject Logistic _lg;
@inject EMailViewModel _evm;
@inject WebServices _ws;
@inject NextCloudViewModel _nvm;
@inject OneDriveViewModel _odvm;
<div class="main cloud-container">
    <div class="cloud-tabs-container">
        <div class="tabs @(_activeTab ? string.Empty : "activeOne")" @onclick="ToggleActiveTab">
            <h4>@_locals["_add"]</h4>
        </div>
        <div class="tabs  @(_activeTab ? "activeOne" : string.Empty)" @onclick="ToggleActiveTab">
            <h4>@_locals["_manage"]</h4>
        </div>
        <div class="active-tab @(_activeTab ? "active-second" : string.Empty)"></div>
    </div>
    <MudIconButton Icon="@Icons.Material.Filled.Info" OnClick="InfoUploadDialog" Size="Size.Small" Color="Color.Primary" Class="@(_lg.IsInfoButtonHide ? string.Empty :  "hide-the-info-buttons" )" />
    <div class="cloud-content-container ">
        <CascadingValue Value="_isLoading" Name="LoadingAnimation">
            @ActiveTab
        </CascadingValue>
    </div>
</div>

@code {
    [Parameter]
    public string SubTab { set; get; }
    private bool _activeTab = false;
    private bool _isLoading = false;
    protected override async Task OnInitializedAsync()
    {
        base.OnInitialized();
        
        _lg.UpdateLanguage += update;
    }
    private RenderFragment ActiveTab => (SubTab?.ToLowerInvariant()) switch
    {
        "add" => @<AddCloud />,
        "manage" => @<ManageCloud/>,
        "browser" => @<CloudFileBrowser/>,
        _ =>  @<AddCloud />
    };
    protected override void OnParametersSet()
    {
        _activeTab = (SubTab?.ToLowerInvariant()) switch
        {
            "add" => false,
            "manage" => true,
            "browser" => true,
            _ => false
        };
    }
    private async Task ToggleActiveTab(){
        _activeTab = !_activeTab;
        if(_activeTab){
            NavigationManager.NavigateTo("/res/cloud/manage");
            _isLoading = true;
            await Task.Delay(2000);

            await _odvm.GetAllOnedriveAccountsAsync();
            await _nvm.GetAllNextCloudAccountsAsync();
            _isLoading = false;
            await InvokeAsync(() =>
            {
                StateHasChanged();
            });
        }else
        {
            NavigationManager.NavigateTo("/res/cloud/add");
        }
    }
    private async void update()
    {
        await InvokeAsync(() =>
        {
            StateHasChanged();
        });
    }
    private void InfoUploadDialog()
    {
        _lg.InfoMessage_1 = _locals["_nextCloudInfo"];
        _lg.InfoMessage_2 = _locals["_oneDriveInfo"];
        _lg.OnInfoModalToggle = true;
        _lg.UpdateInfoModal?.Invoke();
    }
}
